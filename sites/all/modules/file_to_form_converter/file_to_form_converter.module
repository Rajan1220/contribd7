<?php 
/**
 * Implements hook_block_info().
 */
function file_to_form_converter_block_info() {
  $blocks = array();
  $blocks['file_to_form_converter'] = array(
    'info' => t('File To Form Converter'),
    //'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function file_to_form_converter_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'file_to_form_converter':
      $block['subject'] = t('File To Form Converter');
      $block['content'] = drupal_get_form('file_to_form_converter_form');
      break;
  }
  return $block;
}

/**
 * Implements file_to_form_converter_form().
 */
function file_to_form_converter_form($form, &$form_state) {
  $form = array();
  $form['file-to-be-converted'] = array(
    '#type'   => "managed_file",
    '#title'  => t("Upload File To Convert"),
    '#descripion' => t("Only csv format File is allowed."),
    '#upload_location'    => "public://",
    "#upload_validators"  => array("file_validate_extensions" => array("csv")),
    '#required'=>TRUE,
  );
  $form['html_div'] = array(
    '#type' => 'markup',
    '#prefix' => '<div id="form_wrapper">',
    '#suffix' => '</div>',
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Converet',
    '#attributes' => array('onclick' => 'return false;'),
    '#ajax' => array(
        'callback' => 'file_to_form_converter_callback',
        'wrapper' => 'form_wrapper',
        'method' => 'html',
        
      ) 
    );
  return $form;
}

function file_to_form_converter_form_validate($form, &$form_state) {
  $validator = array(
    'file_validate_is_image',
    'file_validate_extensions' => array('csv'),
  );
}
function file_to_form_converter_callback($form, &$form_state)  {
  $file_fid = $form_state['complete form']['file-to-be-converted']['#file']->fid;
  $file_name = $form_state['complete form']['file-to-be-converted']['#file']->filename;
  $file_type = $form_state['complete form']['file-to-be-converted']['#file']->filemime;
  $file_uri = $form_state['complete form']['file-to-be-converted']['#file']->uri;
  $file_size = $form_state['complete form']['file-to-be-converted']['#file']->filesize;
  $file_path = file_create_url($file_uri);
  $file_content = file($file_path, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
  //print convert_file_to_table($file_path,true);
  $output = convert_file_to_table($file_path,true);
  //ajax_command_append('#form_wrapper', $output);
  $commands[] = ajax_command_append('#form_wrapper', $output);
  //$page = array('#type' => 'ajax', '#commands' => $commands);
  return $commands;
}
function file_to_form_converter_form_submit($form, &$form_state) {
  drupal_set_message(t('File uploaded sucessfully !'));
}

function convert_file_to_table($filename, $header=false) {
  $handle = fopen($filename, "r");
  echo '<table>';
  //display header row if true
  if ($header) {
    $csvcontents = fgetcsv($handle);
    echo '<tr>';
    foreach ($csvcontents as $headercolumn) {
      echo "<th>$headercolumn</th>";
    }
    echo '</tr>';
  }
  // displaying contents
  while ($csvcontents = fgetcsv($handle)) {
    echo '<tr>';
    foreach ($csvcontents as $column) {
      echo "<td>$column</td>";
    }
    echo '</tr>';
  }
  echo '</table>';
  fclose($handle);
}
/**
 * Implements hook_preprocess_block().
 */
/*function file_to_form_converter_preprocess_block(&$variables) {
  if ($variables['block']->bid === 'target_block_id') {
  
  } 
  else if ($variables['block']->bid === 'other_target_block_id') {
  
  }
}*/
?>